@page
@model WeeklyViewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Weekly View";

    // Calculate the current date
    var currentDate = DateTime.Today;

    // Calculate the start of the week (Monday)
    var startOfWeek = currentDate.AddDays(-(int)currentDate.DayOfWeek + 1);

    // Create an array for the days of the week
    var daysOfWeek = Enumerable.Range(0, 7)
                               .Select(i => startOfWeek.AddDays(i))
                               .ToArray();

    // Set the allowed date range (current date and up to 3 days prior)
    var allowedDateRangeStart = currentDate.AddDays(-3);
}

<h2>Weekly View</h2>

<!-- Calendar Layout -->
<div class="calendar-container">
    @foreach (var day in daysOfWeek)
    {
        // Check if the day is within the allowed range
        var isWithinAllowedRange = day >= allowedDateRangeStart && day <= currentDate;

        <div class="day @(day == currentDate ? "current-day" : "")">
            <div class="date">@day.ToString("dddd, MMM dd")</div>
            <div class="time-entries">
                @{
                    // Find time slots for the current day
                    var timeSlotsForDay = Model.TimeSlots
                        .Where(ts => ts.TSDate.Date == day.Date)
                        .ToList();
                }
                @if (timeSlotsForDay.Any())
                {
                    @foreach (var timeSlot in timeSlotsForDay)
                    {
                        <div class="time-entry">
                            <p><strong>Time:</strong> @timeSlot.TSDuration</p>
                            <p><strong>Description:</strong> @timeSlot.TSDescription</p>
                        </div>
                    }
                }
                else
                {
                    <p>No time entries yet.</p>
                }
            </div>

            <!-- Only show buttons within the allowed date range -->
            @if (isWithinAllowedRange)
            {
                <button class="edit-btn" onclick="openEditPopup('@day.ToString("dddd, MMM dd")')">Edit Time Slot</button>
                <button class="add-btn">Add Time Slot</button>
            }
            else
            {
                <p class="info-text">Adding/editing time slots is disabled for this date.</p>
            }
        </div>
    }
</div>

<!-- Edit Popup -->
<div id="editPopup" class="popup" style="display:none;">
    <div class="popup-content">
        <span class="close" onclick="closeEditPopup()">&times;</span>
        <h3>Edit Time Entry for <span id="editDate"></span></h3>
        <form method="post">
            <div class="form-group">
                <label for="editTime">Time (HH:MM):</label>
                <input type="text" id="editTime" name="editTime" placeholder="HH:MM" required pattern="^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$" title="Please enter a valid time in HH:MM format." />
            </div>

            <div class="form-group">
                <label for="editDescription">Description:</label>
                <textarea id="editDescription" name="editDescription" rows="3" required></textarea>
            </div>

            <div class="form-group">
                <button type="submit" class="btn">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript for Popup -->
<script>
    function openEditPopup(date) {
        document.getElementById("editPopup").style.display = "block";
        document.getElementById("editDate").textContent = date;  // Set the date in the popup
    }

    function closeEditPopup() {
        document.getElementById("editPopup").style.display = "none";
    }
</script>
